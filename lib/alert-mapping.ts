/**
 * –ú–∞–ø—ñ–Ω–≥ –º—ñ–∂ location_uid –∑ API —Ç–∞ id —Ä–µ–≥—ñ–æ–Ω—ñ–≤ –∑ regions.ts
 * –ö–ª—é—á: location_uid –∑ API, –ó–Ω–∞—á–µ–Ω–Ω—è: id –∑ regions.ts
 */
export const LOCATION_MAPPING: Record<string, number> = {
  "4": 1,   // –í—ñ–Ω–Ω–∏—Ü—å–∫–∞
  "8": 2,   // –í–æ–ª–∏–Ω—Å—å–∫–∞
  "9": 3,   // –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞
  "28": 4,  // –î–æ–Ω–µ—Ü—å–∫–∞
  "10": 5,  // –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞
  "11": 6,  // –ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞
  "12": 7,  // –ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞
  "13": 8,  // –Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞
  "14": 9,  // –ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  "31": 9,  // –º. –ö–∏—ó–≤ -> —Ç–∞–∫–æ–∂ –º–∞–ø–∏—Ç—å—Å—è –Ω–∞ –ö–∏—ó–≤—Å—å–∫—É –æ–±–ª–∞—Å—Ç—å (ID 9)
  "15": 10, // –ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞
  "16": 11, // –õ—É–≥–∞–Ω—Å—å–∫–∞
  "27": 12, // –õ—å–≤—ñ–≤—Å—å–∫–∞
  "17": 13, // –ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞
  "18": 14, // –û–¥–µ—Å—å–∫–∞
  "19": 15, // –ü–æ–ª—Ç–∞–≤—Å—å–∫–∞
  "5": 16,  // –†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞
  "20": 17, // –°—É–º—Å—å–∫–∞
  "21": 18, // –¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞
  "22": 19, // –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞
  "23": 20, // –•–µ—Ä—Å–æ–Ω—Å—å–∫–∞
  "3": 21,  // –•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞
  "24": 22, // –ß–µ—Ä–∫–∞—Å—å–∫–∞
  "26": 23, // –ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞
  "25": 24, // –ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞
  "29": 26, // –ê–† –ö—Ä–∏–º (ID 26 –≤ regions.ts)
  "30": 26, // –º. –°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å -> —Ç–∞–∫–æ–∂ –º–∞–ø–∏—Ç—å—Å—è –Ω–∞ –ê–† –ö—Ä–∏–º (ID 26)
}

/**
 * –ú–∞–ø—ñ–Ω–≥ –º—ñ–∂ regionId –∑ —Å—Ç–∞—Ä–æ–≥–æ API (ukrainealarm.com) —Ç–∞ id —Ä–µ–≥—ñ–æ–Ω—ñ–≤ –∑ regions.ts
 * –°—Ç–∞—Ä–∏–π API –ø–æ–≤–µ—Ä—Ç–∞—î regionId –¥–ª—è –æ–±–ª–∞—Å—Ç–µ–π (State)
 * –ö–ª—é—á: regionId –∑ —Å—Ç–∞—Ä–æ–≥–æ API, –ó–Ω–∞—á–µ–Ω–Ω—è: id –∑ regions.ts
 */
export const OLD_API_REGION_MAPPING: Record<string, number> = {
  "4": 1,   // –í—ñ–Ω–Ω–∏—Ü—å–∫–∞
  "8": 2,   // –í–æ–ª–∏–Ω—Å—å–∫–∞
  "9": 3,   // –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞
  "28": 4,  // –î–æ–Ω–µ—Ü—å–∫–∞
  "10": 5,  // –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞
  "11": 6,   // –ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞
  "12": 7,   // –ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞
  "13": 8,   // –Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞
  "14": 9,   // –ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  "31": 9,   // –º. –ö–∏—ó–≤ -> —Ç–∞–∫–æ–∂ –º–∞–ø–∏—Ç—å—Å—è –Ω–∞ –ö–∏—ó–≤—Å—å–∫—É –æ–±–ª–∞—Å—Ç—å (ID 9)
  "15": 10,  // –ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞
  "16": 11,  // –õ—É–≥–∞–Ω—Å—å–∫–∞
  "27": 12,  // –õ—å–≤—ñ–≤—Å—å–∫–∞
  "17": 13,  // –ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞
  "18": 14,  // –û–¥–µ—Å—å–∫–∞
  "19": 15,  // –ü–æ–ª—Ç–∞–≤—Å—å–∫–∞
  "5": 16,   // –†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞
  "20": 17,  // –°—É–º—Å—å–∫–∞
  "21": 18,  // –¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞
  "22": 19,  // –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞
  "23": 20,  // –•–µ—Ä—Å–æ–Ω—Å—å–∫–∞
  "3": 21,   // –•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞
  "24": 22,  // –ß–µ—Ä–∫–∞—Å—å–∫–∞
  "26": 23,  // –ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞
  "25": 24,  // –ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞
  "9999": 26, // –ê–† –ö—Ä–∏–º (ID 26 –≤ regions.ts) - —Å—Ç–∞—Ä–∏–π API –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î 9999
}

/**
 * –ú–∞–ø—ñ–Ω–≥ —Ä–∞–π–æ–Ω—ñ–≤ –¥–æ –æ–±–ª–∞—Å—Ç–µ–π (–¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ API)
 * –î–µ—è–∫—ñ —Ä–∞–π–æ–Ω–∏ –º–∞—é—Ç—å —Å–≤–æ—ó regionId, –∞–ª–µ –Ω–∞–ª–µ–∂–∞—Ç—å –¥–æ –æ–±–ª–∞—Å—Ç–µ–π
 */
export const DISTRICT_TO_OBLAST_MAPPING: Record<string, number> = {
  // –î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 4)
  "49": 4,  // –ö–∞–ª—å–º—ñ—É—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "50": 4,  // –ö—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "51": 4,  // –ì–æ—Ä–ª—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "52": 4,  // –ú–∞—Ä—ñ—É–ø–æ–ª—å—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "53": 4,  // –î–æ–Ω–µ—Ü—å–∫–∏–π —Ä–∞–π–æ–Ω
  "54": 4,  // –ë–∞—Ö–º—É—Ç—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "55": 4,  // –í–æ–ª–Ω–æ–≤–∞—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "56": 4,  // –ü–æ–∫—Ä–æ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  
  // –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 19)
  "123": 19, // –ö—É–ø'—è–Ω—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "124": 19, // –•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "125": 19, // –Ü–∑—é–º—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "126": 19, // –ë–æ–≥–æ–¥—É—Ö—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "1293": 19, // –º. –•–∞—Ä–∫—ñ–≤ —Ç–∞ –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ–∞–ª—å–Ω–∞ –≥—Ä–æ–º–∞–¥–∞
  
  // –°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 17)
  "114": 17, // –°—É–º—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "115": 17, // –®–æ—Å—Ç–∫–∏–Ω—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "116": 17, // –†–æ–º–µ–Ω—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "117": 17, // –ö–æ–Ω–æ—Ç–æ–ø—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  
  // –ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 24)
  "142": 24, // –ù—ñ–∂–∏–Ω—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "143": 24, // –ü—Ä–∏–ª—É—Ü—å–∫–∏–π —Ä–∞–π–æ–Ω
  
  // –ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 15)
  "106": 15, // –õ—É–±–µ–Ω—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "107": 15, // –ö—Ä–µ–º–µ–Ω—á—É—Ü—å–∫–∏–π —Ä–∞–π–æ–Ω
  "108": 15, // –ú–∏—Ä–≥–æ—Ä–æ–¥—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  
  // –ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 10)
  "80": 10,  // –û–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ–π—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  
  // –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 3)
  "46": 3,   // –ö—Ä–∏–≤–æ—Ä—ñ–∑—å–∫–∏–π —Ä–∞–π–æ–Ω
  "48": 3,   // –°–∏–Ω–µ–ª—å–Ω–∏–∫—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  
  // –ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 13)
  "95": 13,  // –í–æ–∑–Ω–µ—Å–µ–Ω—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "96": 13,  // –ë–∞—à—Ç–∞–Ω—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "97": 13,  // –ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "98": 13,  // –ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  
  // –•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 20)
  "129": 20, // –ë–µ—Ä–∏—Å–ª–∞–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  
  // –ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (ID 9)
  "78": 9,   // –ë–æ—Ä–∏—Å–ø—ñ–ª—å—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
  "79": 9,   // –ë—Ä–æ–≤–∞—Ä—Å—å–∫–∏–π —Ä–∞–π–æ–Ω
}

/**
 * –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ç—Ä–∏–≤–æ–≥–∏ –∑ API alerts.in.ua
 * –ó–≥—ñ–¥–Ω–æ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—î—é: https://api.alerts.in.ua/docs
 */
export interface ApiAlert {
  id: number
  location_title: string
  location_type: "oblast" | "raion" | "city" | "hromada" | "unknown"
  started_at: string
  finished_at: string | null // null = –∞–∫—Ç–∏–≤–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞
  updated_at: string
  alert_type: "air_raid" | "artillery_shelling" | "urban_fights" | "chemical" | "nuclear"
  location_uid: string // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ª–æ–∫–∞—Ü—ñ—ó
  location_oblast?: string
  location_oblast_uid?: string
  location_raion?: string
  notes?: string
  calculated?: boolean
  [key: string]: any
}

/**
 * –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–µ–≥—ñ–æ–Ω—É –∑ regions.ts
 */
export interface Region {
  id: number
  title: string
  titleX: number
  titleY: number
  fontSize: number
  d: string
  disabled?: boolean
  [key: string]: any
}

/**
 * –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–µ–≥—ñ–æ–Ω—É –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º —Ç—Ä–∏–≤–æ–≥–∏
 */
export interface RegionWithStatus extends Region {
  isAlert: boolean
}

/**
 * –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Å—Ç–∞—Ä–æ–≥–æ API (ukrainealarm.com) —É —Ñ–æ—Ä–º–∞—Ç ApiAlert
 * –°—Ç–∞—Ä–∏–π API –ø–æ–≤–µ—Ä—Ç–∞—î –æ–±'—î–∫—Ç–∏ –∑ –ø–æ–ª—è–º–∏: regionId, regionType, activeAlerts
 */
function convertOldApiToNewFormat(oldApiData: any[]): ApiAlert[] {
  const converted: ApiAlert[] = []
  
  oldApiData.forEach((item) => {
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∞–∫—Ç–∏–≤–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏
    if (!item.activeAlerts || !Array.isArray(item.activeAlerts) || item.activeAlerts.length === 0) {
      return
    }
    
    const regionId = String(item.regionId || '')
    const regionType = item.regionType || ''
    
    // –í–∏–∑–Ω–∞—á–∞—î–º–æ oblast ID –Ω–∞ –æ—Å–Ω–æ–≤—ñ regionId —Ç–∞ regionType
    let oblastId: number | undefined
    
    if (regionType === 'State') {
      // –î–ª—è –æ–±–ª–∞—Å—Ç–µ–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä—è–º–∏–π –º–∞–ø—ñ–Ω–≥
      oblastId = OLD_API_REGION_MAPPING[regionId]
    } else if (regionType === 'District' || regionType === 'Community') {
      // –î–ª—è —Ä–∞–π–æ–Ω—ñ–≤ —Ç–∞ –≥—Ä–æ–º–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–∞–ø—ñ–Ω–≥ —Ä–∞–π–æ–Ω->–æ–±–ª–∞—Å—Ç—å
      oblastId = DISTRICT_TO_OBLAST_MAPPING[regionId]
    }
    
    if (!oblastId) {
      // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –º–∞–ø—ñ–Ω–≥ - –ª–æ–≥—É—î–º–æ, –∞–ª–µ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ–≤–Ω—ñ—Å—Ç—é
      // –ú–æ–∂–ª–∏–≤–æ, —Ü–µ –Ω–æ–≤–∏–π —Ä–∞–π–æ–Ω/–≥—Ä–æ–º–∞–¥–∞, —è–∫–∏–π —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ –≤ –º–∞–ø—ñ–Ω–≥
      if (process.env.NODE_ENV === 'development') {
        console.warn(`‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –º–∞–ø—ñ–Ω–≥ –¥–ª—è regionId: ${regionId}, regionType: ${regionType}, regionName: ${item.regionName || 'N/A'}`)
      }
      return
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—Å—ñ —Ç–∏–ø–∏ —Ç—Ä–∏–≤–æ–≥, –∞–ª–µ –¥–ª—è –∫–∞—Ä—Ç–∏ –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ–≤—ñ—Ç—Ä—è–Ω—ñ (AIR)
    // –Ü–Ω—à—ñ —Ç–∏–ø–∏ (ARTILLERY, URBAN_FIGHTS) —Ç–∞–∫–æ–∂ –≤–∞–∂–ª–∏–≤—ñ, –∞–ª–µ –Ω–∞ –∫–∞—Ä—Ç—ñ –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ AIR
    const hasAirAlert = item.activeAlerts.some((alert: any) => alert.type === 'AIR')
    
    // –Ø–∫—â–æ —î –ø–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ - –¥–æ–¥–∞—î–º–æ –¥–æ –∫–∞—Ä—Ç–∏
    if (hasAirAlert) {
      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ location_uid –¥–ª—è —Ü—ñ—î—ó –æ–±–ª–∞—Å—Ç—ñ (–∑–≤–æ—Ä–æ—Ç–Ω–∏–π –º–∞–ø—ñ–Ω–≥)
      // –ú–æ–∂–µ –±—É—Ç–∏ –∫—ñ–ª—å–∫–∞ location_uid –¥–ª—è –æ–¥–Ω—ñ—î—ó –æ–±–ª–∞—Å—Ç—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ö–∏—ó–≤—Å—å–∫–∞: 14 —ñ 31)
      const locationUids = Object.keys(LOCATION_MAPPING).filter(
        uid => LOCATION_MAPPING[uid] === oblastId
      )
      
      // –î–æ–¥–∞—î–º–æ —Ç—Ä–∏–≤–æ–≥—É –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ location_uid (—â–æ–± –ø–æ–∫—Ä–∏—Ç–∏ –≤—Å—ñ –≤–∏–ø–∞–¥–∫–∏)
      locationUids.forEach(locationUid => {
        converted.push({
          location_uid: locationUid,
          finished_at: null, // null –æ–∑–Ω–∞—á–∞—î –∞–∫—Ç–∏–≤–Ω—É —Ç—Ä–∏–≤–æ–≥—É
          alert_type: 'air_raid',
          alertType: 'air_raid',
        } as ApiAlert)
      })
      
      // –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–ª—è –ö—Ä–∏–º—É (ID 26) - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ location_uid "29"
      if (oblastId === 26 && locationUids.length === 0) {
        converted.push({
          location_uid: "29",
          finished_at: null,
          alert_type: 'air_raid',
          alertType: 'air_raid',
        } as ApiAlert)
      }
    }
  })
  
  return converted
}

/**
 * –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–≥—ñ–æ–Ω—ñ–≤ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º —Ç—Ä–∏–≤–æ–≥
 * @param alerts - –º–∞—Å–∏–≤ —Ç—Ä–∏–≤–æ–≥ –∑ API (–º–æ–∂–µ –±—É—Ç–∏ –Ω–æ–≤–∏–π –∞–±–æ —Å—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç)
 * @param regions - –º–∞—Å–∏–≤ —Ä–µ–≥—ñ–æ–Ω—ñ–≤ –∑ regions.ts
 * @returns –º–∞—Å–∏–≤ —Ä–µ–≥—ñ–æ–Ω—ñ–≤ –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º –ø–æ–ª–µ–º isAlert
 */
export function getRegionsWithStatus(
  alerts: any[],
  regions: Region[]
): RegionWithStatus[] {
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö - —Å—Ç–∞—Ä–∏–π API –∞–±–æ –Ω–æ–≤–∏–π
  const isOldApiFormat = alerts.length > 0 && alerts[0].regionId !== undefined && alerts[0].activeAlerts !== undefined
  
  // –Ø–∫—â–æ —Å—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç - –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ
  const normalizedAlerts: ApiAlert[] = isOldApiFormat 
    ? convertOldApiToNewFormat(alerts)
    : alerts as ApiAlert[]
  
  // –°—Ç–≤–æ—Ä—é—î–º–æ Map –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—Ä–∏–≤–æ–≥ –ø–æ location_uid
  const activeAlertsByUid = new Map<string, boolean>()
  
  normalizedAlerts.forEach((alert) => {
    // API alerts.in.ua –ø–æ–≤–µ—Ä—Ç–∞—î location_uid —è–∫ —Ä—è–¥–æ–∫
    const locationUid = alert.location_uid !== undefined 
      ? String(alert.location_uid)
      : null
    
    if (!locationUid) {
      // –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É
      if (process.env.NODE_ENV === 'development') {
        console.warn('Alert without location_uid:', alert);
      }
      return;
    }
    
    // –í–∏–∑–Ω–∞—á–∞—î–º–æ, —á–∏ —Ç—Ä–∏–≤–æ–≥–∞ –∞–∫—Ç–∏–≤–Ω–∞:
    // –ó–≥—ñ–¥–Ω–æ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—î—é API: finished_at === null –æ–∑–Ω–∞—á–∞—î –∞–∫—Ç–∏–≤–Ω—É —Ç—Ä–∏–≤–æ–≥—É
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ alert_type === 'air_raid' –¥–ª—è –ø–æ–≤—ñ—Ç—Ä—è–Ω–∏—Ö —Ç—Ä–∏–≤–æ–≥
    const alertType = alert.alert_type || alert.alertType || ''
    const isActive = alert.finished_at === null && alertType === 'air_raid'
    
    // –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É (—Ç—ñ–ª—å–∫–∏ –≤ development, –¥–ª—è –≤—Å—ñ—Ö –æ–±–ª–∞—Å—Ç–µ–π)
    if (process.env.NODE_ENV === 'development' && isActive) {
      const regionName = LOCATION_MAPPING[locationUid] ? `Region ID ${LOCATION_MAPPING[locationUid]}` : 'Unknown'
      console.log(`üîç –ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ - ${regionName} (UID: ${locationUid}):`, {
        locationUid,
        finished_at: alert.finished_at,
        alert_type: alertType,
        isActive
      });
    }
    
    // –Ø–∫—â–æ –¥–ª—è —Ü—å–æ–≥–æ UID –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞, –∑–∞–ª–∏—à–∞—î–º–æ —ó—ó
    // –Ø–∫—â–æ –Ω—ñ, –∞–ª–µ –ø–æ—Ç–æ—á–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ –∞–∫—Ç–∏–≤–Ω–∞ - –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ
    const currentStatus = activeAlertsByUid.get(locationUid) || false
    activeAlertsByUid.set(locationUid, currentStatus || isActive)
  })
  
  // –°—Ç–≤–æ—Ä—é—î–º–æ Map –¥–ª—è –∑–≥—Ä—É–ø–æ–≤–∞–Ω–∏—Ö —Ç—Ä–∏–≤–æ–≥ –ø–æ id —Ä–µ–≥—ñ–æ–Ω—É
  // –û—Å–∫—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–µ–≥—ñ–æ–Ω –º–æ–∂–µ –º–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ UID (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ö–∏—ó–≤—Å—å–∫–∞: 14 —ñ 31)
  const alertsByRegionId = new Map<number, boolean>()
  
  activeAlertsByUid.forEach((isActive, locationUid) => {
    const regionId = LOCATION_MAPPING[locationUid]
    if (regionId !== undefined) {
      // –Ø–∫—â–æ –¥–ª—è —Ä–µ–≥—ñ–æ–Ω—É –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞, –∑–∞–ª–∏—à–∞—î–º–æ —ó—ó
      // –Ø–∫—â–æ –ø–æ—Ç–æ—á–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ –∞–∫—Ç–∏–≤–Ω–∞ - –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ
      const currentStatus = alertsByRegionId.get(regionId) || false
      alertsByRegionId.set(regionId, currentStatus || isActive)
    } else {
      // –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –Ω–µ–≤—ñ–¥–æ–º–∏—Ö location_uid (—Ç—ñ–ª—å–∫–∏ –≤ development)
      if (process.env.NODE_ENV === 'development') {
        console.warn(`‚ö†Ô∏è location_uid "${locationUid}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –º–∞–ø—ñ–Ω–≥—É!`);
      }
    }
  })
  
  // –î–æ–¥–∞—î–º–æ –ø–æ–ª–µ isAlert –¥–æ –∫–æ–∂–Ω–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É
  const result = regions.map((region) => ({
    ...region,
    isAlert: alertsByRegionId.get(region.id) || false,
  }))
  
  // –ó–∞–≥–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö —Ä–µ–≥—ñ–æ–Ω—ñ–≤ –∑ —Ç—Ä–∏–≤–æ–≥–∞–º–∏ (—Ç—ñ–ª—å–∫–∏ –≤ development)
  if (process.env.NODE_ENV === 'development') {
    const regionsWithAlerts = result.filter(r => r.isAlert);
    if (regionsWithAlerts.length > 0) {
      console.log(`‚úÖ –†–µ–≥—ñ–æ–Ω–∏ –∑ –∞–∫—Ç–∏–≤–Ω–∏–º–∏ —Ç—Ä–∏–≤–æ–≥–∞–º–∏ (${regionsWithAlerts.length}):`, 
        regionsWithAlerts.map(r => `${r.title} (ID: ${r.id})`).join(', ')
      );
    } else {
      console.log('‚ÑπÔ∏è –ê–∫—Ç–∏–≤–Ω–∏—Ö —Ç—Ä–∏–≤–æ–≥ –Ω–µ–º–∞—î');
    }
  }
  
  return result;
}

